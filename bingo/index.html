<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Game Supervisor</title>
    <link href="../DutyTracker/lib/bootstrap.min.css" rel="stylesheet">
    <link href="../DutyTracker/styles.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .bingo-container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .game-area {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Make number caller wider than player cards */
            gap: 30px;
            margin-bottom: 30px;
        }

        .number-caller {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .number-caller h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .current-number {
            text-align: center;
            font-size: 8em; /* Larger number display */
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            min-height: 180px; /* Taller box */
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border: 4px solid #dee2e6;
        }

        .called-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 20px;
            max-height: 380px;
            overflow-y: auto;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .called-number {
            background: #ff6b6b;
            color: white;
            padding: 10px 14px;
            border-radius: 22px;
            font-size: 16px;
            font-weight: bold;
        }

        .card-generator {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card-generator h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .card-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .card-input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            width: 100px;
            text-align: center;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* smaller card footprint */
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .bingo-card {
            background: white;
            border-radius: 10px;
            padding: 10px; /* tighter padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .card-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 12px; /* smaller header */
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px; /* tighter grid */
            margin-bottom: 8px;
        }

        .bingo-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-weight: bold;
            font-size: 10px; /* smaller numbers on cards */
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bingo-cell:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }

        .bingo-cell.marked {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border-color: #ff6b6b;
        }

        .bingo-cell.free {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border-color: #4ecdc4;
        }

        .game-status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .win-message {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .print-section {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 15px;
            border: 2px solid #ffeaa7;
        }

        /* Print styles for cards */
        .print-cards {
            display: none;
        }

        .print-cards.show {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 10px;
        }

        .print-card {
            page-break-inside: avoid;
            break-inside: avoid;
            margin: 0;
            padding: 16px;
            border: 2px solid #333;
            border-radius: 10px;
            background: white;
            width: 100%;
            height: auto;
        }

        .print-card-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .print-bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 12px 0 0 0;
        }

        .print-bingo-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 2px solid #333;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .print-bingo-cell.free {
            background: #4ecdc4;
            color: white;
            border-color: #4ecdc4;
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .current-number {
                font-size: 4em;
            }

            .card-controls {
                flex-direction: column;
            }
        }

        @media print {
            @page {
                size: 8.5in 13in; /* Long bond paper */
                margin: 8mm;
            }
            .game-controls, .stats, .print-section, .download-section, .number-caller, .card-generator {
                display: none;
            }
            
            .container {
                box-shadow: none;
                background: white;
                padding: 0;
            }
            
            .cards-container {
                max-height: none;
                overflow: visible;
            }

            .print-cards {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr); /* 2 columns */
                gap: 6mm; /* spacing between cards */
                padding: 6mm;
            }

            /* Three rows per 13-inch page: (96mm * 3) + (6mm * 2 gaps) + (margins 8mm top/bottom) â‰ˆ 330mm */
            .print-card {
                height: 96mm; /* fixed height to produce 3 rows */
                padding: 8px !important; /* tighter padding to help fit */
                display: flex;
                flex-direction: column;
            }

            /* Reduce grid gap a bit for better fit and remove headers */
            .print-bingo-grid { gap: 6px !important; }
            .print-card-header { display: none !important; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="../homepage/index.html">
          <img src="../DutyTracker/Photos/PHILSCA-LOGO-WINGS.png" alt="AISERS Logo" style="height:48px;width:auto;margin-right:12px;">
          <span class="fw-bold" style="letter-spacing:2px;font-size:1.5rem;">ALLIANCE APP</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="../homepage/index.html">Home</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container with-fixed-navbar">
      <div class="bingo-container">
        <h1>ðŸŽ¯ Adventure BINGO: An AISERS Quest!</h1>
        
        <div class="game-controls">
            <label>Numbers 1 to:</label>
            <input type="number" class="card-input" id="maxNumber" value="75" min="24">
            <button class="btn btn-primary" onclick="newGame()">New Game</button>
            <button class="btn btn-secondary" onclick="callNumber()" id="callBtn">Call Number</button>
            <button class="btn btn-secondary" onclick="autoPlay()" id="autoBtn">Auto Play</button>
            <button class="btn btn-success" onclick="generateCards()">Generate Cards</button>
            <button class="btn btn-warning" onclick="downloadCards()">Download Cards</button>
            <button class="btn btn-secondary" onclick="printCards()">Print Cards</button>
        </div>

        <div class="game-status" id="gameStatus">

        </div>

        <div class="win-message" id="winMessage">
            ðŸŽ‰ BINGO! Game Complete! ðŸŽ‰
        </div>

        <div class="game-area">
            <div class="number-caller">
                <h2>Number Caller</h2>
                <div class="current-number" id="currentNumber">-</div>
                <div class="called-numbers" id="calledNumbers">
                    <!-- Called numbers will appear here -->
                </div>
            </div>

            <div class="card-generator">
                <h2>Player Cards</h2>
                <div class="card-controls">
                    <label>Number of Cards:</label>
                    <input type="number" class="card-input" id="cardCount" value="6" min="1" max="20">
                    <button class="btn btn-success" onclick="generateCards()">Generate</button>
                    <button class="btn btn-secondary" onclick="clearCards()">Clear</button>
                </div>
                <div class="cards-container" id="cardsContainer">
                    <!-- Generated cards will appear here -->
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="numbersCalled">0</div>
                <div class="stat-label">Numbers Called</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="remainingNumbers">-</div>
                <div class="stat-label">Remaining Numbers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cardsGenerated">0</div>
                <div class="stat-label">Cards Generated</div>
            </div>
        </div>

        <!-- Hidden print area for cards -->
        <div class="print-cards" id="printCards">
            <!-- Cards will be generated here for printing -->
        </div>
      </div>
    </div>
    <script src="../DutyTracker/lib/bootstrap.bundle.min.js"></script>

    <script>
        class BingoGame {
            constructor() {
                this.numbers = [];
                this.calledNumbers = [];
                this.playerCards = [];
                this.isAutoPlaying = false;
                this.autoPlayInterval = null;
                this.totalNumbers = 75;
                this.init();
            }

            init() {
                this.generateNumbers();
                this.updateStats();
            }

            generateNumbers() {
                this.numbers = Array.from({length: this.totalNumbers}, (_, i) => i + 1);
            }

            generateBingoCard() {
                // Generate 25 numbers for the bingo card (5x5 grid)
                const cardNumbers = [];
                const usedNumbers = new Set();

                // Generate 24 random numbers (excluding the center free space)
                while (cardNumbers.length < 24) {
                    const randomNum = Math.floor(Math.random() * this.totalNumbers) + 1;
                    if (!usedNumbers.has(randomNum)) {
                        usedNumbers.add(randomNum);
                        cardNumbers.push(randomNum);
                    }
                }

                // Create 5x5 grid with center as free space
                const bingoCard = [];
                let cardIndex = 0;
                for (let row = 0; row < 5; row++) {
                    const rowNumbers = [];
                    for (let col = 0; col < 5; col++) {
                        if (row === 2 && col === 2) {
                            // Center position - free space
                            rowNumbers.push('FREE');
                        } else {
                            rowNumbers.push(cardNumbers[cardIndex++]);
                        }
                    }
                    bingoCard.push(rowNumbers);
                }

                return bingoCard;
            }

            generateCards(count) {
                this.playerCards = [];
                for (let i = 0; i < count; i++) {
                    this.playerCards.push({
                        id: i + 1,
                        numbers: this.generateBingoCard(),
                        marked: new Set()
                    });
                }
                this.renderCards();
                this.updateStats();
            }

            renderCards() {
                const container = document.getElementById('cardsContainer');
                container.innerHTML = '';

                this.playerCards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'bingo-card';
                    
                    const header = document.createElement('div');
                    header.className = 'card-header';
                    header.textContent = `Player ${card.id}`;
                    cardElement.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = 'bingo-grid';

                    for (let row = 0; row < 5; row++) {
                        for (let col = 0; col < 5; col++) {
                            const cell = document.createElement('div');
                            cell.className = 'bingo-cell';
                            
                            const number = card.numbers[row][col];
                            if (number === 'FREE') {
                                cell.textContent = 'FREE';
                                cell.classList.add('free');
                            } else {
                                cell.textContent = number;
                                cell.onclick = () => this.toggleMark(index, row, col);
                            }
                            
                            grid.appendChild(cell);
                        }
                    }

                    cardElement.appendChild(grid);
                    container.appendChild(cardElement);
                });
            }

            toggleMark(cardIndex, row, col) {
                const card = this.playerCards[cardIndex];
                const cells = document.querySelectorAll('.bingo-card')[cardIndex].querySelectorAll('.bingo-cell');
                const index = row * 5 + col;
                const cell = cells[index];
                
                if (card.numbers[row][col] !== 'FREE') {
                    cell.classList.toggle('marked');
                    const key = `${row}-${col}`;
                    if (card.marked.has(key)) {
                        card.marked.delete(key);
                    } else {
                        card.marked.add(key);
                    }
                }
            }

            callNumber() {
                if (this.calledNumbers.length >= this.totalNumbers) {
                    alert('All numbers have been called!');
                    return null;
                }

                let availableNumbers = this.numbers.filter(num => !this.calledNumbers.includes(num));
                const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                const calledNumber = availableNumbers[randomIndex];
                
                this.calledNumbers.push(calledNumber);
                this.updateDisplay();
                this.updateStats();
                
                return calledNumber;
            }

            updateDisplay() {
                const currentNumberEl = document.getElementById('currentNumber');
                const calledNumbersEl = document.getElementById('calledNumbers');
                
                if (this.calledNumbers.length > 0) {
                    const last = this.calledNumbers[this.calledNumbers.length - 1];
                    const letter = this.getBingoLetter(last);
                    currentNumberEl.textContent = letter ? `${letter}-${last}` : String(last);
                } else {
                    currentNumberEl.textContent = '-';
                }

                calledNumbersEl.innerHTML = '';
                this.calledNumbers.forEach(num => {
                    const numEl = document.createElement('div');
                    numEl.className = 'called-number';
                    const letter = this.getBingoLetter(num);
                    numEl.textContent = letter ? `${letter}-${num}` : String(num);
                    calledNumbersEl.appendChild(numEl);
                });
            }

            updateStats() {
                document.getElementById('numbersCalled').textContent = this.calledNumbers.length;
                document.getElementById('remainingNumbers').textContent = this.totalNumbers - this.calledNumbers.length;
                document.getElementById('cardsGenerated').textContent = this.playerCards.length;
            }

            checkWin(cardIndex) {
                const card = this.playerCards[cardIndex];
                if (!card) return false;

                // Check rows
                for (let row = 0; row < 5; row++) {
                    let rowComplete = true;
                    for (let col = 0; col < 5; col++) {
                        const key = `${row}-${col}`;
                        if (card.numbers[row][col] !== 'FREE' && !card.marked.has(key)) {
                            rowComplete = false;
                            break;
                        }
                    }
                    if (rowComplete) return true;
                }

                // Check columns
                for (let col = 0; col < 5; col++) {
                    let colComplete = true;
                    for (let row = 0; row < 5; row++) {
                        const key = `${row}-${col}`;
                        if (card.numbers[row][col] !== 'FREE' && !card.marked.has(key)) {
                            colComplete = false;
                            break;
                        }
                    }
                    if (colComplete) return true;
                }

                // Check diagonals
                let diagonal1Complete = true;
                let diagonal2Complete = true;
                
                for (let i = 0; i < 5; i++) {
                    const key1 = `${i}-${i}`;
                    const key2 = `${i}-${4-i}`;
                    
                    if (card.numbers[i][i] !== 'FREE' && !card.marked.has(key1)) {
                        diagonal1Complete = false;
                    }
                    if (card.numbers[i][4-i] !== 'FREE' && !card.marked.has(key2)) {
                        diagonal2Complete = false;
                    }
                }

                return diagonal1Complete || diagonal2Complete;
            }

            newGame() {
                this.calledNumbers = [];
                this.isAutoPlaying = false;
                if (this.autoPlayInterval) {
                    clearInterval(this.autoPlayInterval);
                    this.autoPlayInterval = null;
                }
                
                this.generateNumbers();
                this.updateDisplay();
                this.updateStats();
                
                document.getElementById('winMessage').style.display = 'none';
                document.getElementById('gameStatus').textContent = 'New game started! Generate cards and start calling numbers.';
                document.getElementById('callBtn').disabled = false;
                document.getElementById('autoBtn').disabled = false;
            }

            autoPlay() {
                if (this.isAutoPlaying) {
                    this.stopAutoPlay();
                } else {
                    this.startAutoPlay();
                }
            }

            startAutoPlay() {
                this.isAutoPlaying = true;
                document.getElementById('autoBtn').textContent = 'Stop Auto Play';
                document.getElementById('callBtn').disabled = true;
                
                this.autoPlayInterval = setInterval(() => {
                    if (this.calledNumbers.length >= this.totalNumbers) {
                        this.stopAutoPlay();
                        return;
                    }
                    
                    this.callNumber();
                    // Check for wins on all cards
                    for (let i = 0; i < this.playerCards.length; i++) {
                        if (this.checkWin(i)) {
                            document.getElementById('winMessage').style.display = 'block';
                            document.getElementById('gameStatus').textContent = `Player ${i + 1} has BINGO!`;
                            this.stopAutoPlay();
                            return;
                        }
                    }
                }, 2000);
            }

            stopAutoPlay() {
                this.isAutoPlaying = false;
                document.getElementById('autoBtn').textContent = 'Auto Play';
                document.getElementById('callBtn').disabled = false;
                
                if (this.autoPlayInterval) {
                    clearInterval(this.autoPlayInterval);
                    this.autoPlayInterval = null;
                }
            }

            clearCards() {
                this.playerCards = [];
                document.getElementById('cardsContainer').innerHTML = '';
                this.updateStats();
            }

            generatePrintCards() {
                const printContainer = document.getElementById('printCards');
                printContainer.innerHTML = '';

                this.playerCards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'print-card';

                    const grid = document.createElement('div');
                    grid.className = 'print-bingo-grid';

                    for (let row = 0; row < 5; row++) {
                        for (let col = 0; col < 5; col++) {
                            const cell = document.createElement('div');
                            cell.className = 'print-bingo-cell';
                            
                            const number = card.numbers[row][col];
                            if (number === 'FREE') {
                                cell.textContent = 'FREE';
                                cell.classList.add('free');
                            } else {
                                cell.textContent = number.toString();
                            }
                            
                            grid.appendChild(cell);
                        }
                    }

                    cardElement.appendChild(grid);
                    printContainer.appendChild(cardElement);
                });

                // Force a reflow to ensure content is rendered
                printContainer.offsetHeight;
            }

            setTotalNumbers(total) {
                const minimumAllowed = 24;
                if (isNaN(total) || total < minimumAllowed) {
                    total = minimumAllowed;
                }
                this.totalNumbers = total;
                this.generateNumbers();
                // Reset called numbers when total changes to avoid inconsistency
                this.calledNumbers = [];
                this.updateDisplay();
                this.updateStats();
            }

            getBingoLetter(num) {
                if (num >= 1 && num <= 15) return 'B';
                if (num >= 16 && num <= 30) return 'I';
                if (num >= 31 && num <= 45) return 'N';
                if (num >= 46 && num <= 60) return 'G';
                if (num >= 61 && num <= 75) return 'O';
                return '';
            }
        }

        // Initialize the game
        let game = new BingoGame();

        // Global functions for button clicks
        function newGame() {
            const max = parseInt(document.getElementById('maxNumber').value) || 75;
            game.setTotalNumbers(max);
            game.newGame();
            document.getElementById('gameStatus').textContent = `New game with numbers 1 to ${game.totalNumbers}. Generate cards and start calling numbers.`;
        }

        function callNumber() {
            const calledNumber = game.callNumber();
            if (calledNumber) {
                const letter = game.getBingoLetter(calledNumber);
                document.getElementById('gameStatus').textContent = `Called number: ${letter ? `${letter}-` : ''}${calledNumber}`;
            }
        }

        function autoPlay() {
            game.autoPlay();
        }

        function generateCards() {
            const count = parseInt(document.getElementById('cardCount').value) || 6;
            game.generateCards(count);
            document.getElementById('gameStatus').textContent = `Generated ${count} player cards!`;
        }

        function clearCards() {
            game.clearCards();
            document.getElementById('gameStatus').textContent = 'All cards cleared!';
        }

        function printCards() {
            if (game.playerCards.length === 0) {
                alert('No cards to print! Generate some cards first.');
                return;
            }
            game.generatePrintCards();
            document.getElementById('printCards').classList.add('show');
            window.print();
            document.getElementById('printCards').classList.remove('show');
        }

        async function downloadCards() {
            if (game.playerCards.length === 0) {
                alert('No cards to download! Generate some cards first.');
                return;
            }

            try {
                // Generate print cards for capture
                game.generatePrintCards();
                document.getElementById('printCards').classList.add('show');

                // Wait longer for proper rendering
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Try to capture the print area
                const printArea = document.getElementById('printCards');
                
                // Generate a 2-column x 3-row PDF layout for LONG BOND (8.5in x 13in)
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: [215.9, 330.2] });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 8; // mm
                const columnGap = 6; // mm between columns
                const contentWidth = pageWidth - margin * 2;
                const colWidth = (contentWidth - columnGap) / 2; // two columns

                // Card layout sizes
                const headerHeight = 0; // no header for print/PDF
                const cellSize = 16; // mm
                const gridGap = 2; // mm between cells
                const gridSize = cellSize * 5 + gridGap * 4; // total grid height/width
                const cardVerticalPadding = 6; // mm top+bottom around grid
                const cardHeight = headerHeight + cardVerticalPadding + gridSize + cardVerticalPadding; // ~86mm
                const rowSpacing = 6; // mm between rows

                let currentY = margin;

                game.playerCards.forEach((card, index) => {
                    const colIndex = index % 2; // 0 left, 1 right
                    const rowIndex = Math.floor(index / 2);

                    // Compute Y based on row; if a new row would exceed page, go to new page
                    if (colIndex === 0) {
                        // For left column, decide if we need a new row
                        if (currentY + cardHeight > pageHeight - margin) {
                            pdf.addPage();
                            currentY = margin;
                        }
                    }

                    const xStart = margin + colIndex * (colWidth + columnGap);
                    const yStart = currentY;

                    // No header text

                    // Draw grid
                    const gridStartX = xStart;
                    const gridStartY = yStart + headerHeight + cardVerticalPadding;
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'normal');

                    for (let r = 0; r < 5; r++) {
                        for (let c = 0; c < 5; c++) {
                            const x = gridStartX + c * (cellSize + gridGap);
                            const y = gridStartY + r * (cellSize + gridGap);
                            // Border
                            pdf.rect(x, y, cellSize, cellSize);
                            // Text
                            const number = card.numbers[r][c];
                            if (number === 'FREE') {
                                pdf.setFont('helvetica', 'bold');
                                pdf.text('FREE', x + 3, y + cellSize / 2 + 2);
                                pdf.setFont('helvetica', 'normal');
                            } else {
                                pdf.text(number.toString(), x + 5, y + cellSize / 2 + 2);
                            }
                        }
                    }

                    // Advance Y only after rendering the right column
                    if (colIndex === 1) {
                        currentY += cardHeight + rowSpacing; // row spacing aligned to print CSS
                    }
                });

                // Download the PDF
                pdf.save('bingo-cards.pdf');

                // Hide print area
                document.getElementById('printCards').classList.remove('show');
                
                document.getElementById('gameStatus').textContent = 'Cards downloaded as PDF!';
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
                document.getElementById('printCards').classList.remove('show');
            }
        }
    </script>
</body>
</html>
