<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Student Database</title>
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .barcode-img {
            margin: 0 10px 10px 0;
        }

        .student-card {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f8f9fa;
        }

        .section-title {
            margin-top: 32px;
        }
    </style>
</head>

<body>

    <div class="container mt-4 with-fixed-navbar">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="index.html" class="btn btn-secondary">‚Üê Back</a>
            <div>
                <button id="clearAll" class="btn btn-danger me-2">Clear All</button>
                <button id="exportExcel" class="btn btn-success">Export to Excel</button>
            </div>
        </div>
        <h1 class="mb-4">Student Barcode Database</h1>
        <form id="addStudentForm" class="row g-2 mb-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="addStudentId" placeholder="Student ID" required>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="addStudentName" placeholder="Student Name" required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="addStudentSection" placeholder="Section" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Add / Update Student</button>
            </div>
        </form>
        <div class="mb-3">
            <label for="excelInput" class="form-label">Import Excel File (.xlsx):</label>
            <input type="file" id="excelInput" accept=".xlsx" class="form-control" />
        </div>
        <div class="mb-3">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control"
                    placeholder="Search by ID, name, or section...">
                <button class="btn btn-outline-secondary" type="button" id="clearSearch">Clear</button>
            </div>
        </div>
        <div id="database"></div>
    </div>

    <!-- Delete All Confirmation Modal -->
    <div class="modal fade" id="deleteAllModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete All Students</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">Warning: This action cannot be undone. All students and their barcode data
                        will be permanently deleted.</p>
                    <p>To confirm, please type "Delete" in the box below:</p>
                    <input type="text" class="form-control" id="deleteConfirmation"
                        placeholder="Type 'Delete' to confirm">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteAll" disabled>Delete All
                        Students</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="lib/firebase-config.js"></script>
    <script src="lib/firebase-service.js"></script>

    <script src="lib/bootstrap.bundle.min.js"></script>
    <script src="lib/JsBarcode.all.min.js"></script>
    <script src="lib/xlsx.full.min.js"></script>
    <script src="lib/encoder.js"></script>
    <script>
        // Sample data (replace with your real data or import from Excel)
        const SAMPLE_STUDENTS = [];

        function saveStudents() {
            localStorage.setItem('barcodeStudents', JSON.stringify(students));
        }

        function loadStudents() {
            const data = localStorage.getItem('barcodeStudents');
            if (data) {
                try {
                    return JSON.parse(data);
                } catch (e) {
                    return [...SAMPLE_STUDENTS];
                }
            }
            return [...SAMPLE_STUDENTS];
        }

        function ensureUniqueIds(students) {
            return students.map(s => {
                s.uniqueId = s.studentId;
                return s;
            });
        }

        let students = ensureUniqueIds(loadStudents());

        function groupBySection(students) {
            const sections = {};
            students.forEach(s => {
                if (!sections[s.section]) sections[s.section] = [];
                sections[s.section].push(s);
            });
            return sections;
        }

        function renderDatabase() {
            const dbDiv = document.getElementById('database');
            dbDiv.innerHTML = '';

            // Get search term
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Filter students based on search term
            let filteredStudents = students;
            if (searchTerm) {
                filteredStudents = students.filter(student =>
                    student.studentId.toLowerCase().includes(searchTerm) ||
                    student.studentName.toLowerCase().includes(searchTerm) ||
                    student.section.toLowerCase().includes(searchTerm)
                );
            }

            const sections = groupBySection(filteredStudents);
            Object.keys(sections).sort().forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `<h2 class="section-title">Section ${section}</h2>`;
                sections[section].forEach((student, idx) => {
                    const ref = encodeStudentData ? encodeStudentData(student.studentId) : student.studentId;
                    const card = document.createElement('div');
                    card.className = 'student-card row align-items-center';
                    card.innerHTML = `
                        <div class="col-md-3 col-12 text-center">
                            <svg id="barcode-${ref}"></svg>
                        </div>
                        <div class="col-md-8 col-12">
                            <strong>ID:</strong> ${student.studentId}<br>
                            <strong>Name:</strong> ${student.studentName}<br>
                            <strong>Section:</strong> ${student.section}<br>
                            <strong>Barcode Ref:</strong> ${ref}<br>
                            <small class="text-muted">Unique ID: ${student.studentId}</small>
                        </div>
                        <div class="col-md-1 col-12 text-end">
                            <button class="btn btn-sm btn-danger delete-student" title="Delete Student" data-id="${student.studentId}"><span aria-hidden="true">üóëÔ∏è</span></button>
                        </div>
                    `;
                    sectionDiv.appendChild(card);
                    setTimeout(() => {
                        try {
                            JsBarcode(`#barcode-${ref}`, ref, { format: "CODE128", width: 2, height: 60, displayValue: true });
                        } catch (e) { console.error('Barcode error:', e); }
                    }, 0);
                });
                dbDiv.appendChild(sectionDiv);
            });

            // Attach delete handlers
            document.querySelectorAll('.delete-student').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const studentId = this.getAttribute('data-id');
                    if (!confirm(`Are you sure you want to delete officer ${studentId}? This will remove them from Firebase.`)) return;

                    try {
                        // Delete from Firebase
                        if (window.dutyFirebaseService) {
                            await window.dutyFirebaseService.deleteOfficer(studentId);
                        } else {
                            console.warn('Firebase service not available, deleting local only');
                        }

                        // Update local cache
                        students = students.filter(s => s.studentId !== studentId);
                        saveStudents();
                        renderDatabase();
                    } catch (error) {
                        alert('Error deleting officer: ' + error.message);
                    }
                });
            });
        }

        // Sync from Database Button Logic
        const syncBtn = document.createElement('button');
        syncBtn.id = 'syncBtn';
        syncBtn.className = 'btn btn-info me-2 text-white';
        syncBtn.innerHTML = 'üîÑ Sync from Database';
        syncBtn.onclick = async () => {
            if (!window.dutyFirebaseService) {
                alert('Firebase service not initialized.');
                return;
            }
            syncBtn.disabled = true;
            syncBtn.innerHTML = 'üîÑ Syncing...';
            try {
                const officers = await window.dutyFirebaseService.getOfficers();
                students = officers.map(o => ({
                    uniqueId: o.studentId,
                    studentId: o.studentId,
                    studentName: o.studentName,
                    section: o.section
                }));
                students = ensureUniqueIds(students);
                saveStudents();
                renderDatabase();
                alert(`Synced ${students.length} officers from Firebase.`);
            } catch (error) {
                console.error(error);
                alert('Error syncing from database: ' + error.message);
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = 'üîÑ Sync from Database';
            }
        };
        // Insert Sync button before Export button
        const exportBtn = document.getElementById('exportExcel');
        exportBtn.parentNode.insertBefore(syncBtn, exportBtn);


        // Excel import handler
        const excelInput = document.getElementById('excelInput');
        excelInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                // Expecting header: ID, Name, Section
                const header = rows[0].map(h => h.toLowerCase());
                const newStudents = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row[header.indexOf('studentid')] && row[header.indexOf('studentname')] && row[header.indexOf('section')]) {
                        newStudents.push({
                            uniqueId: String(row[header.indexOf('studentid')]),
                            studentId: String(row[header.indexOf('studentid')]),
                            studentName: String(row[header.indexOf('studentname')]),
                            section: String(row[header.indexOf('section')])
                        });
                    }
                }
                // Merge: update existing or add new
                // Note: Bulk import currently only updates LOCAL. 
                // To support Firebase bulk import, we'd need loop and await, which is slow/costly.
                // Keeping as local-only for now unless requested otherwise.
                const studentMap = {};
                students.forEach(s => { studentMap[s.studentId] = s; });
                newStudents.forEach(s => { studentMap[s.studentId] = s; });
                students = Object.values(studentMap);
                students = ensureUniqueIds(students);
                renderDatabase();
                saveStudents();
                alert('Imported to LOCAL storage. Click "Add/Update" on individual items to sync to Firebase, or implement bulk sync.');
            };
            reader.readAsArrayBuffer(file);
        });

        // Add/Edit student form handler
        const addStudentForm = document.getElementById('addStudentForm');
        const studentIdInput = document.getElementById('addStudentId');
        const studentNameInput = document.getElementById('addStudentName');
        const studentSectionInput = document.getElementById('addStudentSection');

        // Add event listener for student ID input
        studentIdInput.addEventListener('input', function () {
            const studentId = this.value.trim();
            if (studentId) {
                const existingStudent = students.find(s => s.studentId === studentId);
                if (existingStudent) {
                    studentNameInput.value = existingStudent.studentName;
                    studentSectionInput.value = existingStudent.section;
                } else {
                    studentNameInput.value = '';
                    studentSectionInput.value = '';
                }
            }
        });

        addStudentForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const studentId = document.getElementById('addStudentId').value.trim();
            const studentName = document.getElementById('addStudentName').value.trim();
            const section = document.getElementById('addStudentSection').value.trim();
            if (!studentId || !studentName || !section) return;

            const submitBtn = addStudentForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = 'Saving...';

            try {
                // Save to Firebase
                if (window.dutyFirebaseService) {
                    await window.dutyFirebaseService.addOfficer({ studentId, studentName, section });
                } else {
                    console.warn('Firebase service not available, saving local only');
                }

                // Update local cache
                let found = false;
                students = students.map(s => {
                    if (s.studentId === studentId) {
                        found = true;
                        return { ...s, studentName, section };
                    }
                    return s;
                });
                if (!found) {
                    students.push({ uniqueId: studentId, studentId, studentName, section });
                }
                students = ensureUniqueIds(students);
                renderDatabase();
                saveStudents();
                addStudentForm.reset();
            } catch (error) {
                alert('Error saving officer: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        });

        // Add search functionality
        document.getElementById('searchInput').addEventListener('input', function () {
            renderDatabase();
        });

        document.getElementById('clearSearch').addEventListener('click', function () {
            document.getElementById('searchInput').value = '';
            renderDatabase();
        });

        // Delete All functionality
        const deleteAllModal = new bootstrap.Modal(document.getElementById('deleteAllModal'));
        const deleteConfirmation = document.getElementById('deleteConfirmation');
        const confirmDeleteAll = document.getElementById('confirmDeleteAll');

        document.getElementById('clearAll').addEventListener('click', function () {
            deleteConfirmation.value = '';
            confirmDeleteAll.disabled = true;
            deleteAllModal.show();
        });

        deleteConfirmation.addEventListener('input', function () {
            confirmDeleteAll.disabled = this.value !== 'Delete';
        });

        confirmDeleteAll.addEventListener('click', async function () {
            if (deleteConfirmation.value === 'Delete') {
                if (!confirm("This will delete ALL officers from Firebase one by one. Are you sure?")) return;

                // Optional: Delete from Firebase iteratively (dangerous/costly)
                // For safety/speed, we might just clear local, but user expects consistency.
                if (window.dutyFirebaseService) {
                    // alert("Batch delete not implemented to prevent accidental data loss. Clearing local only.");
                    // If we really want to supported it:
                    for (const s of students) {
                        try {
                            await window.dutyFirebaseService.deleteOfficer(s.studentId);
                        } catch (e) { console.error(e); }
                    }
                }

                students = [];
                renderDatabase();
                saveStudents();
                deleteAllModal.hide();
            }
        });

        document.getElementById('exportExcel').addEventListener('click', function () {
            // Prepare data for export (include uniqueId = studentId)
            const exportData = [
                ['uniqueId', 'studentId', 'studentName', 'section']
            ];
            students.forEach(s => {
                exportData.push([s.studentId, s.studentId, s.studentName, s.section]);
            });
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Students');
            XLSX.writeFile(wb, 'barcode-students.xlsx');
        });

        // Initial render
        renderDatabase();
    </script>
</body>

</html>